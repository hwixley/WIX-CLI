name: Generate Stdout Image & Update Cache

# Controls when the action will run. Triggers the workflow on push events
on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - .github/workflows/main.yml
      - '*.sh'
      - src/**

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Check out repository under $GITHUB_WORKSPACE, so the job can access it
    - uses: actions/checkout@v3

    # Setup apt dependencies
    - name: Setup dependencies
      run: |
        sudo apt -y update
        sudo apt -y install ghostscript fonts-freefont-otf imagemagick csvkit
        sudo sed -i 's/\(<policy domain="resource" name="width" value="\)[^"]*/\1160KP/' /etc/ImageMagick-6/policy.xml
        sudo sed -i 's/\(<policy domain="resource" name="height" value="\)[^"]*/\1160KP/' /etc/ImageMagick-6/policy.xml
        printf "TERM=xterm; export TERM\n" >> "$HOME/.${SHELL##*/}rc"
      shell: bash

    # Run the script
    - name: Run script file
      run: |
        chmod +x wyx-cli.sh
        ./wyx-cli.sh img_stdout
        rm src/data/.cache/cmdinfo.wyx
        ./wyx-cli.sh
      shell: bash

    # Commit and push changes
    - name: Commit changes
      run: |
        git config --local user.name "WYX-CLI Bot"
        git config --local user.email "hwixley1@gmail.com"
        git pull
        git add .generated/wyxcli-output-preview.png src/data/.cache/cmdinfo.wyx
        git commit -m "GH-Action: Update 'wyx' stdout image"
        git push